<!doctype html><head><meta charset="utf-8"/><script>window.NIGHT=1</script><script src="../eveal.js/eveal.js"></script></head><body>
<style>
pre.stretch code { max-height: 100% !important; }
.slide-background {
  background-image: url("bg.jpg");
}
</style>

<section data-background-image="welcome.jpg" data-background-size="contain" data-background-color="black"></section>

---
<!-- .slide: data-background="nomad.jpg" -->
GitLab + Nomad = A Dream Come True<br>
Tracey Jaquith<br><br>
bit.ly/3ara7cD




---
## xxx quickies?
- finish tracey.dev.archive.org train links
- nomad README.md -- move "monitoring GUI urls" further "up" and add
  easiest https://nomad-host:4646
    then enter NOMAD_TOKEN
- apltv try green BG loop
- presskit should have slide advancer

---
- high level diagram of talk/traffic?
- k8s bad month?
- consul secrets
- make your own cluster on digi ocean for $20 links & talk links
- link to setup.sh

---
- xxx update title, title slide, bitly, re-copy snippets
- build action arrow as proceed
x- hello-world sections appear as sections are talking about (magic show/arrive)
- bring back the hashistack during demo build
  to show how traffic will go w/ url
twitter jacquie faster

gist of a few lines of code w/ title linked to where the full part is


---
@tracey_pooh üß∏<br>
Internet Archive üèõÔ∏è<br>
TV Architect<br>
¬∑ video/audio ¬∑ devops ¬∑ javascript ¬∑<br><br>

<span class="fragment highlight-red">slides</span>: https://bit.ly/3ara7cD<br>
repo: [gitlab/internetarchive](https://gitlab.com/internetarchive/nomad)<br>


---
<img src="i/containers-and-tracey.jpg"/><br>
bit.ly/3ara7cD


---
## Approach & Goals
- Make `nomad` an easy swap with `kubernetes`
- Use GitLab's [build] phase
  - build and `docker push` to registry
- <span class="fragment highlight-red">Custom [deploy] phase</span>

bit.ly/3ara7cD


---
<section data-background-image="how.drawio.svg" data-background-size="contain" data-background-color="#eee"></section>

---
<section data-background-image="how2.drawio.svg" data-background-size="contain" data-background-color="#eee"></section>


---
## tl;dr ü•±
```yml
include:
  - remote: 'https://gitlab.com/internetarchive/nomad/-/raw/master/.gitlab-ci.yml'
```
add üëÜ to your GitLab repository :
- top-level file:
- [.gitlab-ci.yml](https://gitlab.com/internetarchive/nomad/-/blob/master/.gitlab-ci.yml)


---
## tl;dr ü•±
{GitLab repository}<br>
[Settings] [CI/CD] [Variables]<br>

| | |
| -- | --
| `NOMAD_ADDR`  | `https://pod.archive.org:4646`
| `NOMAD_TOKEN` | `133t-z6rf-1234-1243bcd35199187`


---
## .gitlab-ci.yml
## GitLab ‚è©  Nomad
<pre><code class="hljs yaml"
>deploy:
  stage: deploy
  script:
</code></pre>
<pre class="fragment fade-up"><code class="hljs yaml"
>    ‚Äî wget  gitlab.com/internetarchive/nomad/-/raw/master/project.nomad
    ‚Äî mv  project.nomad  project.hcl
    ‚Äî sed -i "s/NOMAD_VAR_SLUG/$NOMAD_VAR_SLUG/" project.hcl
</code></pre>
<pre class="fragment fade-up"><code class="hljs yaml"
>    # write GitLab env vars starting with "CIÔºø" to env var file
    ‚Äî node -e 'console.log(JSON.stringify(Object.fromEntries(Object.entries(process.env).filter(([k, v]) => k.startsWith("CI_")))))' >| /tmp/env.json
</code></pre>
<pre class="fragment fade-up"><code class="hljs yaml"
>    # write env vars starting w/ "NOMADÔºøSECRETÔºø" to env var file
    ‚Äî echo NOMAD_SECRETS=$(node -e 'console.log(JSON.stringify(Object.fromEntries(Object.entries(process.env).filter(([k, v]) => k.startsWith("NOMAD_SECRET_")).map(([k ,v]) => [k.replace(/^NOMAD_SECRET_/,""), v]))))' | sed 's/":"/"="/g') >| /tmp/env.env
</code></pre>
<pre class="fragment fade-up"><code class="hljs yaml"
>    ‚Äî nomad run  -var-file=/tmp/env.json  -var-file=/tmp/env.env  project.hcl
</code></pre>
<p class="fragment fade-up">
see
[full .gitlab-ci.yml](https://gitlab.com/internetarchive/nomad/-/blob/master/.gitlab-ci.yml)
for more
</p>

---
## nomad project
- generic template: [project.nomad](https://gitlab.com/internetarchive/nomad/-/blob/master/project.nomad)

- uses template vars + GitLab CI/CD Auto DevOps variables
<pre class="fragment fade-up"><code class="hljs bash"
>$CI_COMMIT_REF_SLUG
$CI_REGISTRY_IMAGE
..
$NOMAD_VAR_MEMORY
$NOMAD_SECRET_DATABASE_URL
</pre></code>

- leverages: [HCL v2](https://www.nomadproject.io/docs/job-specification/hcl2)
<pre class="fragment fade-up"><code class="hljs yaml"
>network {
    dynamic "port" {
      #  port.key == portnumber   port.value == portname
      for_each = merge(var.PORTS, var.PG, {})
      labels = [ "${port.value}" ]
      content {
        to = port.key
      }}}
</pre></code>



---
## [minimal project](https://gitlab.com/internetarchive/nomad/-/blob/master/etc/hello-world.hcl)  usable with GitLab


---
<pre><code class="hljs yaml"
>job "hello-world" {
  datacenters = ["dc1"]
  group "hello-world" {
    network { port "http" { to = 5000 } }
</code></pre>
<pre class="fragment fade-up"><code class="hljs yaml"
>    task "hello-world" {
      driver = "docker"
      config {
        image = "${var.CI_REGISTRY_IMAGE}/${var.CI_COMMIT_REF_SLUG}:${var.CI_COMMIT_SHA}"
        ports = [ "http" ]
</code></pre>
<pre class="fragment fade-up"><code class="hljs yaml"
>        auth {
          server_address = "${var.CI_REGISTRY}"
          username = "${var.CI_REGISTRY_USER}"
          password = "${var.CI_REGISTRY_PASSWORD}"
    }}}
</code></pre>
<pre class="fragment fade-up"><code class="hljs yaml"
>    service {
      name = "hello-world"
      tags = ["urlprefix-${var.CI_PROJECT_PATH_SLUG}-${var.CI_COMMIT_REF_SLUG}.${var.KUBE_INGRESS_BASE_DOMAIN}:443/"]
      port = "http"
</code></pre>
<pre class="fragment fade-up"><code class="hljs yaml"
>      check {
        type     = "http"
        port     = "http"
        path     = "/"
        interval = "10s"
        timeout  = "2s"
}}}}
</code></pre>


---
### has nomad cluster?  try this now! üòä
```
NOMAD_ADDR=...
NOMAD_TOKEN=...
wget https://gitlab.com/internetarchive/nomad/-/raw/master/etc/hello-world.hcl
nomad run hello-world.hcl
```


---
## NOMAD_VAR_SLUG üêå

Semantic hostnames üôå

<pre>
https://services-timemachine
         ‚ï∞‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚ïØ  ‚ï∞‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚ïØ
          group    project
</pre><pre class="fragment fade-up">
https://frontend-website-123-ticket-3939-fix-things
         ‚ï∞‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚ïØ  ‚ï∞‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚ïØ   ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ
          group    project          branch
</pre>

---
### ... same semantic slug for nomad jobs names
```bash
nomad status
ID                              Type     Priority  Status   Submit Date
fabio                           system   50        running  2020-07-04T12:14:32-07:00
internetarchive-word-salad      service  50        running  2020-07-04T04:24:31-07:00
internetarchive-www             service  50        running  2020-07-04T04:36:02-07:00
internetarchive-www-mobile-nav  service  50        running  2020-07-04T13:59:16-07:00
services-timemachine            service  50        running  2020-07-04T14:00:05-07:00
x-thumb                         service  50        running  2020-07-04T04:34:54-07:00
```


---
### DEMO TIME
## üöÄ


---
## Hello my World
### 3 files, 10 lines
</code></pre>
<pre class="fragment fade-up">
clock.js

<code class="hljs js"
>var http = require('http')
http.createServer((req, res) => {
  res.end(`the time is: ${new Date()}`)
}).listen(5000)
</code></pre>

<pre class="fragment fade-up">
Dockerfile

<code class="hljs bash"
>FROM node:alpine
COPY . /app
CMD node /app/clock.js
</code></pre>

<pre class="fragment fade-up">
.gitlab-ci-yml

<code class="hljs yml"
>include:
  - remote: 'https://gitlab.com/internetarchive/nomad/-/raw/master/.gitlab-ci.yml'
</code></pre>



---
## Full project.nomad
https://gitlab.com/internetarchive/nomad/-/blob/master/project.nomad



---
## Customize
Optional CI/CD variables customize
[project.nomad](https://gitlab.com/internetarchive/nomad/-/blob/master/project.nomad)

```
NOMAD_VAR_BIND_MOUNTS
NOMAD_VAR_CHECK_PROTOCOL
NOMAD_VAR_COUNT
NOMAD_VAR_CPU
NOMAD_VAR_HEALTH_TIMEOUT
NOMAD_VAR_HOME
NOMAD_VAR_HOSTNAMES
NOMAD_VAR_MEMORY
NOMAD_VAR_MYSQL
NOMAD_VAR_NO_DEPLOY
NOMAD_VAR_PG
NOMAD_VAR_PORTS
NOMAD_VAR_PV
NOMAD_VAR_PV_DB
```

Add any ‚òùüèΩ to your `.gitlab-ci.yml`.<br>
([more info](https://gitlab.com/internetarchive/nomad/-/blob/master/README.md))

---
### `docker login`  issues?  Try:
  - Setup: Group [Settings] [Repository] [Deploy Tokens]
    - create with
     `read_registry` scope
  - Add to: Group [Settings] [CI/CD] [Variables]
    - `CI_R2_USER`
    - `CI_R2_PASS`


---
## Monitoring & Usage üïµÔ∏è
- [aliases](https://gitlab.com/internetarchive/nomad/-/blob/master/aliases)
  - based on CWD & git branch and info
  - `nom-ssh` - ssh into container
  - `nom-cp` - "hot copy" file from laptop to container
  - `nom-app` - open url for webapp
  - `nom-status` - detailed info on your deployment


---
## Additional Help
- caching: `docker.sock` not `docker-in-docker`
- [create a nomad cluster](https://gitlab.com/internetarchive/nomad/-/blob/master/setup.sh)
- [create domain https certs](https://gitlab.com/internetarchive/nomad/-/blob/master/create-https-certs.sh)
- [gitlab pipeline examples](https://gitlab.com/internetarchive/word-salad/-/pipelines)
- [gitlab runners & monorepos](https://docs.gitlab.com/ee/ci/large_repositories)



---
## Results: üèõÔ∏è  move to Nomad
- 70 repos/webapps deployed
- 200+ review apps deployed
- deploys 2x+ faster
- all main development uses gitlab + nomad review apps

---
<!-- .slide: data-background="https://media.giphy.com/media/q4ICE9wYvOwBG/giphy.gif" -->
# The End


---
<!-- .slide: data-background="thanks.jpg" -->
<div style="color: #ddd; margin-top:20%">
Thank You!<br>
slides: bit.ly/3ara7cD<br>
repo: [gitlab/internetarchive](https://gitlab.com/internetarchive/nomad)<br>
</div>
