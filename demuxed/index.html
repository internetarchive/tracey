<!doctype html><head><meta charset="utf-8"/><script>window.NIGHT=1</script><script src="../eveal.js/eveal.js"></script><style> .slide-background { background-image: url("i/bg.jpg"); }</style>
<meta property="title" content="30,000 fps nginx - to Russia with Love : Demuxed 2021 : Tracey Jaquith">
<!-- üòä fish: https://sylvan.apple.com/Videos/BO_A014_C008_SDR_20190719_SDR_2K_AVC.mov -->
</head><body>

---
# 30,000 fps nginx
## To Russia with Love

Demuxed 2021<br>
Tracey Jaquith

slides: tracey.dev.archive.org


---
@tracey_pooh üß∏<br>
Internet Archive üèõÔ∏è
<div class="fragment"><br>
TV Architect<br>
¬∑ video/audio ¬∑ devops ¬∑ javascript ¬∑<br>
</div>

<div class="fragment"><br><br>
<span class="fragment highlight-red">slides</span>: https://tracey.dev.archive.org<br>
</div>

---
## xxx - points to factor in...
- figure out how to patch & test mp4
- `hg` mercurial
- email devl list - `patchbomb`
- 3500 line single `.c` file
- best C code I've ever seen
  - reads top-to-bottom
  - airtight
  - intimidating
  - exciting
- 1st guy: "why not just use a smart client/browser?"
  - misses entire point --> "then why would i ever use nginx mp4 module??"
  - "good point.."
  - gets me to Roman, the 4th most committer at nginx ; 2nd most committer in mp4 module
- back & forth, with Roman, who wizardly points out I can use ...
  - STTS - Time-To-Sample atom
  - parse STSS - Sync Sample entries - list of keyframs
    - each STSS entry is a [duration][count] tuple
    - start with first frame, end once hit desired start
    - if desired start is keyframe, nothing to do!
    - otherwise, "save" prior keyframe location
    - now we know how many frames to move:
      - from 30fps, duration 1001 (typical)
      - to duration 1, ~30000fps (typical)
- my patch: https://raw.githubusercontent.com/traceypooh/mod_h264_streaming--intra-keyframes/master/nginx-mp4.patch: 158 lines
- 6/15/2021
- updated patch: `tracey-2021-06-15.patch` (138 lines)
- `exact_video_adjustment()`
- revised patch: 234 lines
- mentioned: "your patch first line exceeds 67 char limit".. :(
  - http://nginx.org/en/docs/contributing_changes.html
- changes name / new config setting to: `mp4_seek_key_frame`
```ini
location /video/ {
    mp4;
    mp4_buffer_size       1m;
    mp4_max_buffer_size   5m;
    mp4_limit_rate        on;
    mp4_limit_rate_after  30s;
    mp4_seek_key_frame    on;
}
```
   https://nginx.org/en/docs/http/ngx_http_mp4_module.html
- `ngx_http_mp4_rewind_stts_data()`
- "Based on a patch by Tracey Jaquith."
- "Can you test this?"
  - 2 months at 50% time go by..., exercising 1-3h/day, losing 15 pounds ;-)
  - 9/7/2021 ( https://forum.nginx.org/read.php?29,291866,292368#msg-292368 )
  - tests heavily on linux and macosx -- looks good!
- "If I won't end up being a committer, can you credit Internet Archive, too?" :)
- "Based on a patch by Tracey Jaquith, Internet Archive"
- "We had a discussion here about enabling this feature by default or maybe making this the only supported behavior. What do you think?" 9/9/2021

---
## .hg/hgrc
```ini
[paths]
default = http://hg.nginx.org/nginx

[ui]
username = Tracey Jaquith <tracey@archive.org>

[extensions]
hgext.patchbomb =

[email]
to = nginx-devel@nginx.org
from = Tracey Jaquith <tracey@archive.org>
method = smtp

[smtp]
host = mail.archive.org
tls = starttls
username = tracey@archive.org
```
- hg commit
- hg log |head # get hash like: 7872:1879d49fe0cf
- hg email --test 7872:1879d49fe0cf
- hg email 7872:5da9c62fa610

Add optional "mp4_exact_start" nginx config off/on to show video between keyframes.

archive.org has been using mod_h264_streaming with a similar "exact start" patch from me since 2013.
We just moved to nginx mp4 module and are using this patch.
The technique is to find the video keyframe just before the desired "start" time, and send
that down the wire so video playback can start immediately.
Next calculate how many video samples are between the keyframe and desired "start" time
and update the STTS atom where those samples move the duration from (typically) 1001 to 1.
This way, initial unwanted video frames play at ~1/30,000s -- so visually the
video & audio start playing immediately.

You can see an example before/after here (nginx binary built with mp4 module + patch):

https://pi.archive.org/0/items/CSPAN_20160425_022500_2011_White_House_Correspondents_Dinner.mp4?start=12&end=30
https://pi.archive.org/0/items/CSPAN_20160425_022500_2011_White_House_Correspondents_Dinner.mp4?start=12&end=30&exact=1

Tested on linux and macosx.

(this is me: https://github.com/traceypooh )


---
## Why?
Server-side mp4 lossless precise seeking is hard.
<div class="fragment">
Most of the time, you jump between keyframes.
</div>
<div class="fragment">
üí° Idea!  Speedup the FPS of the video frames just before the exact wanted seek point.
</div>


---
## Why server-side clipping?
xxx

---
## Lossless
Let's hack some (dyslexia unfriendly) STTS and STSS moov atoms...


---
### Keyframes

<img src="https://www.canon.com.hk/cpx/public/images/tech/article/video/EOS_Movie_Compression_Options_All_I_and_IPB/IPB_Compression_EN_s.jpg">

<small>credit: [www.canon.com.hk](https://www.canon.com.hk/cpx/en/technical/va_EOS_Movie_Compression_Options_All_I_and_IPB.html)</small>


---
### Partial frames
<img src="partial-frames.jpg">

<small>credit: [nickyguides.digital-digest.com](https://nickyguides.digital-digest.com/keyframes.htm)</small>



---
### I P B frames
<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/7b/IBBPBB_inter_frame_group_of_pictures.svg/1920px-IBBPBB_inter_frame_group_of_pictures.svg.png">

<small>credit: [wikipedia](https://en.wikipedia.org/wiki/Inter_frame#Typical_Group_Of_Pictures_%28GOP%29_structure)</small>


---
http://nginx.org/en/docs/contributing_changes.html
```text
The commit message should have a single-line synopsis followed by verbose description after an empty line. It is desirable that the first line is no longer than 67 symbols. The resulting changeset as a patch can be obtained using the hg export command:
```


---
Getting Sources
Mercurial is used to store source code. The repository can be cloned with the following command:

hg clone http://hg.nginx.org/nginx


---
# 12y ago
https://git.archive.org/ia/petabox/-/blob/6614fbaaf77c7718dad1f5ff393029d2b2f4c2db/sw/bin/nginx-README.txt
```text
nginx v0.8
mod_h264_streaming-2.1rc2
if !start && !end -- return .mp4 AS IS (some user .mp4 uploads fail w/ mod_h264..)
```

---
# xxx
natty
nginx_mod_h264_streaming-2.2.7.tar.gz;

---
# tracey oct2013
I've added a new "&exact=1" optional arg that is used with "&start=X" arg
that will perceptually skip through any first partial GOP to the exact
start time.
- @see https://github.com/traceypooh/mod_h264_streaming--intra-keyframes )

https://github.com/traceypooh/mod_h264_streaming--intra-keyframes/blob/master/nginx-mod_h264_exact-start.patch

---
# Exact patch gist
mod_h264 always started at closest keyframe **at or before** desired start time.
approach:
- reset audio samples to wanted start time
- video samples parsed into PTS
  - so make all undesired initial first video frames have *just* one PTS value higher than last frame

---
# 2014
exact end patch from P√©ter Vajda, PhD, Stanford
https://github.com/traceypooh/mod_h264_streaming--intra-keyframes/blob/master/nginx-mod_h264_exact-end.patch

---
# 2015
"AS IS" patch
https://github.com/traceypooh/mod_h264_streaming--intra-keyframes/commits/master/nginx-mod_h264_ASIS.patch

---
# 2017
chrome duration patch:
https://github.com/traceypooh/mod_h264_streaming--intra-keyframes/blob/master/nginx-mod_h264_chrome-duration.patch

---
# 9/2020
nginx rebuild to use `ipscrub` module, ubuntu focal, deployed to all archive.org nodes


---
# 5/11/2021
nginx `ipscrub` patch improvements (more entry, same salt/crypt as prior `lua` IP hider

---
## 5/18/2021
## üò≥ ü•∫
<pre class="fragment fade-up" style="white-space: pre-wrap"><code class="hljs bash"
>
git commit -m 'workaround (TV) mp4 clips with "&exact=1" having some kind of strange new double free() segfault - WEBDEV-4445'
</code></pre>
<div class="fragment">
ü§¶‚Äç‚ôÄÔ∏è üò∞
</div>
<div class="fragment">
ü•µ
</div>
<div class="fragment">
ü•Ä
</div>

---
... got 98% of segfaults fixed by patching & completely taking over `mod_h264_streaming`'s memory management.  but that 2%...


---
# 6/1/2021
```sh
git commit -m '
Move from long abandoned (tracey as sole maintainer) mod_h264_streaming module
to nginx "house version" (optional) http_mp4_module.

Like the older, the newer module still needs an "exact=1" precise start time patch
(though it is a smaller patch/need.  the newer module already uses an "exact end" time feature - which is a nice upgrade).

Will be trying to get the patch refined and "upstream" to nginx proper
'
```
https://github.com/traceypooh/mod_h264_streaming--intra-keyframes/blob/master/nginx-mp4.patch



---
<!-- .slide: data-background="https://media.giphy.com/media/q4ICE9wYvOwBG/giphy.gif" -->
# The End
